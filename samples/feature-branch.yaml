flowit:
  version: "0.1"

  config:
    abort-on-failed-action: true
    strict: false
    shell: /usr/bin/env bash

  variables:
    circleci-username: ${CIRCLECI_USERNAME}
    circleci-project-name: ${CIRCLECI_PROJECT_NAME}
    circleci-token: ${CIRCLECI_TOKEN}

  branches:
  - id: master
    name: master
    eternal: true 
    protected: true

  - id: feature
    name: $<prefix>$<suffix>
    prefix: feature/$<jira-issue-id>/
    suffix: $<feature-branch-suffix>
    eternal: false
    protected: false
    transitions:
    - from: master
      to: [ master:local ]

  tags:
  - id: release
    format: "[0-9]+\\.[0-9]+"
    branches: [ master ]

  state-machines:
    - id: simple-machine
      stages: [ start, refresh, publish, finish ]
      initial-stage: start
      final-stages: [ finish ]
      transitions:
      - from: [ "!finish" ]
        to: [ "!start" ]

  workflows:
  - id: feature
    state-machine: simple-machine
    stages:
    - id: start
      args:
      - < feature-branch-suffix | Branch name without prefix >
      - < jira-issue-id | Related Jira Issue ID >
      conditions:
      - "[[ $(jira list --status $<jira-issue-id>) == *'Open'* ]]"
      actions:
      - git checkout master
      - git pull origin master
      - git checkout -b $<branches[feature].name> master
      - jira transition $<jira-issue-id> 'In progress'

    - id: refresh
      actions:
      - git checkout master
      - git pull origin master
      - git checkout $<branches[feature].name>
      - git rebase master

    - id: publish
      conditions:
      - ./run-tests.sh
      - "[[ $(jira list --status $<jira-issue-id>) == *'In Progress'* ]]"
      actions:
      - git checkout $<branches[feature].name>
      - git push origin $<branches[feature].name>
      - jira transition $<jira-issue-id> 'In code review'

    - id: finish
      conditions:
      - "[[ $(curl https://circleci.com/api/v1.1/project/github/$<circleci-username>/$<circleci-project-name>?circle-token=$<circleci-token>) == *'Passed'* ]]"
      - "[[ $(hub pr list --base develop --head $<branches[feature].name>) == *'Merged'* ]]"
      actions:
      - jira transition $<jira-issue-id> 'Done'
      - git checkout master
      - git pull origin master
      - git branch -D $<branches[feature].name>
      - git push --delete origin $<branches[feature].name>
